const ftp = require('basic-ftp');
const path = require('path');
const fs = require('fs');
require("dotenv").config();

// Configuration FTP
const FTP_HOST = process.env.FTP_HOST;
const FTP_USER = process.env.FTP_USER;
const FTP_PASSWORD = process.env.FTP_PASSWORD;
const FTP_DIR = 'upload';
const BASE_URL = 'http://77.37.124.206:3000/images/ftpuser';
const FTP_DIR = 'upload';  // Conserv√© comme dans le code original
const BASE_URL = 'http://77.37.124.206:3000/images/ftpuser';  // Conserv√© comme dans le code original

/**
 * Fonction pour t√©l√©charger un fichier avec r√©essais automatiques


  while (attempt < retries) {
    try {
      // Connexion FTP
      // Connexion au serveur FTP
      await client.access({
        host: FTP_HOST,
        user: FTP_USER,

      });

      // V√©rifier si le r√©pertoire existe
      let directoryExists = true;
      try {
        await client.cd(FTP_DIR);
      } catch (err) {
        await client.send(`MKD ${FTP_DIR}`);
        await client.cd(FTP_DIR);
        directoryExists = false;
      }

      if (!directoryExists) {
        console.log(`‚ö†Ô∏è Le r√©pertoire ${FTP_DIR} n'existe pas. Tentative de cr√©ation...`);
        try {
          await client.ensureDir(FTP_DIR);
          console.log(`‚úÖ R√©pertoire ${FTP_DIR} cr√©√© avec succ√®s`);
        } catch (createErr) {
          console.error(`‚ùå Impossible de cr√©er le r√©pertoire ${FTP_DIR}: ${createErr.message}`);
          throw new Error(`Impossible de cr√©er le r√©pertoire ${FTP_DIR}`);
        }
      }

      // Upload du fichier
      console.log(`üöÄ T√©l√©chargement du fichier: ${fileName}`);
      await client.uploadFrom(tempFilePath, fileName);
      
      // D√©finir les permissions pour un acc√®s public (644 = rw-r--r--)
      try {
        await client.send(`SITE CHMOD 644 ${fileName}`);
        console.log(`‚úÖ Permissions du fichier ${fileName} d√©finies comme publiques`);
      } catch (chmodErr) {
        console.warn(`‚ö†Ô∏è Impossible de d√©finir les permissions: ${chmodErr.message}`);
        // Continuer m√™me si CHMOD √©choue
      }
      
      console.log(`‚úÖ Fichier ${fileName} t√©l√©charg√© avec succ√®s et accessible publiquement`);

      // Modifier les permissions pour rendre le fichier public
      await client.send(`SITE CHMOD 644 ${FTP_DIR}/${fileName}`);

      console.log(`‚úÖ Fichier ${fileName} t√©l√©charg√© avec succ√®s`);

      // Construire l'URL publique
      // Construire l'URL selon le format original
      const fileUrl = `${BASE_URL}/${FTP_DIR}/${fileName}`;

      // Nettoyage


/**
 * Middleware pour g√©rer l'upload d'images vers un serveur FTP
 * Garde le m√™me nom que dans le code original
 */
const UploadImage = (req, res, next) => {
  if (!req.files) return next();

  Promise.all(uploadPromises)
    .then(() => {
      req.uploadedFiles = uploadedFiles;
      
      // Ajouter les informations des fichiers √† la r√©ponse √©galement
      // pour faciliter l'acc√®s direct
      res.locals.uploadedFiles = uploadedFiles;
      
      next();
    })
    .catch((error) => {
      console.error("‚õî √âchec de l'upload des fichiers:", error);
      res.status(500).send({ error: "L'upload des fichiers a √©chou√©" });
    });
};

module.exports = UploadImage;
